<mat-sidenav-container class="sidenav-container">
  <mat-sidenav
    #sidenav
    mode="side"
    [(opened)]="sideNavOpened"
    class="team-sidenav"
  >
    <mat-toolbar color="primary">
      <button mat-icon-button (click)="togglePanel()" class="sidenav-close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </mat-toolbar>

    <app-team-members
      [members]="teamMembers"
      [teamId]="teamId"
    ></app-team-members>
  </mat-sidenav>

  <mat-sidenav-content>
    <mat-toolbar color="primary" *ngIf="!sideNavOpened">
      <button mat-icon-button (click)="togglePanel()" class="menu-btn">
        <mat-icon>menu</mat-icon>
      </button>
      <span class="toolbar-title">View Team Members</span>
    </mat-toolbar>

    <section class="container">
      <header>
        <h1>Welcome to Your Team To-Do List</h1>
        <p>Manage your tasks efficiently with your team.</p>

        <section class="actions">
          <button mat-raised-button color="primary" (click)="createTask()">
            Create New Task
          </button>

          <button mat-raised-button color="primary" (click)="showStats()">View team report</button>

          <mat-checkbox [(ngModel)]="showMyTasks" (change)="loadTodos()">
            View my tasks
          </mat-checkbox>

          <mat-checkbox [(ngModel)]="showCompletedTasks" (change)="loadTodos()">
            View completed tasks
          </mat-checkbox>
        </section>
      </header>

      <table mat-table [dataSource]="pagedTasks" class="mat-elevation-z8">
        <!-- Title Column -->
        <ng-container matColumnDef="title">
          <th mat-header-cell *matHeaderCellDef>Title</th>
          <td mat-cell *matCellDef="let task">
            <a class="task-title" (click)="showTaskDetails(task)">
              {{ task.title }}
            </a>
          </td>
        </ng-container>

        <!-- Assigned To Column -->
        <ng-container matColumnDef="assigned_to">
          <th mat-header-cell *matHeaderCellDef>Assigned To</th>
          <td mat-cell *matCellDef="let task">
            {{ getUserNameById(task.assigned_to.id)}}
          </td>
        </ng-container>

        <!-- Edit Column -->
        <ng-container matColumnDef="edit">
          <th mat-header-cell *matHeaderCellDef>Edit</th>
          <td mat-cell *matCellDef="let task; let i = index">
            <button
              mat-icon-button
              [disabled]="!canEditOrDelete(task)"
              (click)="editTask(i)"
            >
              <mat-icon>edit</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Delete Column -->
        <ng-container matColumnDef="delete">
          <th mat-header-cell *matHeaderCellDef>Delete</th>
          <td mat-cell *matCellDef="let task; let i = index">
            <button
              mat-icon-button
              [disabled]="!canEditOrDelete(task)"
              (click)="deleteTask(i)"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <ng-container matColumnDef="completed">
          <th mat-header-cell *matHeaderCellDef>Completed</th>
          <td mat-cell *matCellDef="let task; let i = index">
            <mat-checkbox
              [(ngModel)]="task.completed_at"
              [disabled]="!canToggleComplete(task)"
              (change)="toggleCompletion(task)"
            >
            </mat-checkbox>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let task; columns: displayedColumns;"
          [class.completed-task]="task.completed_at"
        ></tr>
      </table>

      <section *ngIf="tasks && (tasks.length == 0) && !loadError">
        <p style="text-align: center; color: #6b7280">
          No tasks/todos found for this team.
        </p>
      </section>

      <section *ngIf="loadError && tasks">
        <p style="color: #ef4444; text-align: center; margin-top: 1rem">
          Failed to load tasks/todos. Please try again later.
        </p>
      </section>

      <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons>
      </mat-paginator>
    </section>
  </mat-sidenav-content>
</mat-sidenav-container>

<app-task-modal
  [show]="showTaskModal"
  [isEditMode]="isEditMode"
  [task]="taskForm"
  [teamMembers]="teamMemberNames"
  [canEditAssignedTo]="isCurrentUserTeamLead()"
  (save)="submitTask($event)"
  (close)="closeModal()"
></app-task-modal>

<!-- Task Details Modal -->
<app-task-details-modal
  [task]="selectedTask"
  (close)="closeTaskDetails()"
></app-task-details-modal>

<!-- Delete Modal -->
<app-delete-modal
  [show]="showDeleteModal"
  title="Confirm Delete"
  [message]="'Are you sure you want to delete this task?'"
  [details]="taskToDelete ? '\'' + taskToDelete.title + '\' assigned to ' + getUserNameById(taskToDelete.assigned_to.id) : ''"
  (confirm)="confirmDelete()"
  (cancel)="cancelDelete()"
></app-delete-modal>
